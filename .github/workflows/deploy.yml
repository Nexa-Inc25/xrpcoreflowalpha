name: Deploy to Droplet

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (optional)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Lint placeholder (no-op)
        run: |
          echo "Linting not configured yet"

  deploy:
    name: Deploy to Droplet
    needs: build_test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_PRIVATE_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY_B64 }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y openssh-client rsync
          mkdir -p ~/.ssh
          if [ -n "${SSH_PRIVATE_KEY_B64:-}" ]; then
            echo "$SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/id_ed25519
          else
            printf "%s" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_ed25519
          fi
          chmod 600 ~/.ssh/id_ed25519
          # Convert key to PEM format to avoid libcrypto parsing issues in some environments
          ssh-keygen -p -m PEM -f ~/.ssh/id_ed25519 -N ""
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
          # Preload known_hosts for strict host key checking
          ssh-keyscan -p "${SSH_PORT:-22}" "${SSH_HOST}" >> ~/.ssh/known_hosts
          # Smoke test key works (no interactive prompt expected)
          ssh -p ${SSH_PORT:-22} -o StrictHostKeyChecking=yes -o BatchMode=yes -o IdentitiesOnly=yes "${SSH_USER}@${SSH_HOST}" echo ok

      - name: Rsync code to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          RSYNC_RSH="ssh -p ${SSH_PORT:-22} -o StrictHostKeyChecking=yes -o BatchMode=yes -o IdentitiesOnly=yes"
          rsync -az --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '.venv' \
            --exclude '__pycache__' \
            --exclude '.env' \
            --exclude 'node_modules' \
            -e "$RSYNC_RSH" \
            ./ "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/"

      - name: Install deps and restart service
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh -p ${SSH_PORT:-22} -o StrictHostKeyChecking=yes -o BatchMode=yes -o IdentitiesOnly=yes "${SSH_USER}@${SSH_HOST}" \
            "cd ${DEPLOY_PATH} && if [ -x .venv/bin/pip ]; then .venv/bin/pip install -r requirements.txt; fi && sudo systemctl restart ${SERVICE_NAME} && echo 'Service restarted'"
