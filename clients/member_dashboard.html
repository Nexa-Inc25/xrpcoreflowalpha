-<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ZK AlphaFlow – Member Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #020617; /* slate-950 */
        color: #e5e7eb; /* gray-200 */
      }
      a { color: #38bdf8; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;

      const SDUICard = ({ component }) => {
        return (
          <div
            style={{
              borderRadius: 12,
              padding: 12,
              margin: "6px 12px",
              background: "#111",
              borderLeft: `4px solid ${component.color || "#4b5563"}`,
            }}
          >
            {component.title && (
              <div style={{ fontWeight: 700, marginBottom: 4 }}>{component.title}</div>
            )}
            {component.summary && (
              <div style={{ opacity: 0.9, fontSize: 14 }}>{component.summary}</div>
            )}
            <div
              style={{
                display: "flex",
                gap: 12,
                marginTop: 6,
                fontSize: 12,
                opacity: 0.8,
              }}
            >
              {component.confidence !== undefined && (
                <div>Conf: {component.confidence}%</div>
              )}
              {component.predicted_impact && <div>{component.predicted_impact}</div>}
              {component.time_delta && <div>{component.time_delta}</div>}
            </div>
          </div>
        );
      };

      const SDUIFeed = () => {
        const [feed, setFeed] = useState([]);

        useEffect(() => {
          const fetchFeed = async () => {
            try {
              const res = await fetch("/sdui/feed");
              const data = await res.json();
              setFeed(data.feed || []);
            } catch (e) {
              console.error("SDUI fetch error", e);
            }
          };
          fetchFeed();
          const id = setInterval(fetchFeed, 15000);
          return () => clearInterval(id);
        }, []);

        return (
          <div style={{ marginTop: 40 }}>
            <h2 style={{ fontSize: 20, margin: "0 16px 12px" }}>Recent Flow Events</h2>
            {feed.map((p) => (
              <div key={p.timestamp || Math.random()}>
                {(p.components || []).map((c) => (
                  <SDUICard component={c} key={c.id || Math.random()} />
                ))}
              </div>
            ))}
          </div>
        );
      };

      const FlowDashboard = () => {
        const [flow, setFlow] = useState(null);
        const [prices, setPrices] = useState(null);

        useEffect(() => {
          const poll = async () => {
            try {
              const res = await fetch("/dashboard/flow_state");
              const data = await res.json();
              setFlow(data);
            } catch (e) {
              console.error("flow_state fetch error", e);
            }
          };
          poll();
          const id = setInterval(poll, 10000);
          return () => clearInterval(id);
        }, []);

        useEffect(() => {
          const pollPrices = async () => {
            try {
              const res = await fetch("/dashboard/market_prices");
              const data = await res.json();
              setPrices(data);
            } catch (e) {
              console.error("market_prices fetch error", e);
            }
          };
          pollPrices();
          const id = setInterval(pollPrices, 30000);
          return () => clearInterval(id);
        }, []);

        if (!flow) {
          return (
            <div
              style={{
                padding: 40,
                minHeight: "100vh",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
              }}
            >
              Loading signal...
            </div>
          );
        }

        const godark = flow.godark || {};
        const macro = flow.macro || {};

        const markets = (prices && prices.markets) || [];
        const pickMarket = (sym) => markets.find((m) => m.symbol === sym) || {};
        const fmtPrice = (m) => {
          const v = m && typeof m.price === "number" ? m.price : null;
          if (!v || !isFinite(v)) return "—";
          return v.toFixed(v >= 100 ? 1 : 4);
        };
        const xrp = pickMarket("XRP");
        const eth = pickMarket("ETH");
        const spy = pickMarket("SPY");
        const qqq = pickMarket("QQQ");

        const level = (v, fallback) => (v || fallback || "").toString().toLowerCase();
        const godarkLevel = level(godark.risk_level, "normal");
        const macroLevel = level(macro.risk_level, "normal");
        const palette = {
          critical: "#b91c1c", // red-700
          high: "#f97316",     // orange-500
          elevated: "#eab308", // yellow-500
          normal: "#10b981",   // emerald-500
        };
        const godarkAccent = palette[godarkLevel] || "#6b7280";
        const macroAccent = palette[macroLevel] || "#6b7280";

        return (
          <div
            style={{
              padding: 32,
              minHeight: "100vh",
              boxSizing: "border-box",
              background: "#020617",
            }}
          >
            <h1
              style={{
                fontSize: 28,
                textAlign: "center",
                marginBottom: 24,
                letterSpacing: 0.5,
                fontWeight: 600,
              }}
            >
              ZK AlphaFlow — Live Regime Map
            </h1>

            <div
              style={{
                maxWidth: 820,
                margin: "0 auto 16px",
                fontSize: 12,
                opacity: 0.75,
                textAlign: "center",
              }}
            >
              Monitoring <strong>Ethereum mainnet zk-proof flows</strong> for GoDark risk and
              <strong> ES / NQ CME futures notional</strong> for macro execution waves.
            </div>

            <div
              style={{
                display: "flex",
                gap: 24,
                justifyContent: "center",
                flexWrap: "wrap",
                marginBottom: 16,
              }}
            >
              {/* GoDark Tile */}
              <div
                style={{
                  background: "#020617",
                  padding: 20,
                  borderRadius: 12,
                  minWidth: 260,
                  maxWidth: 360,
                  textAlign: "left",
                  border: "1px solid #1f2937", // gray-800
                  boxShadow: "0 10px 30px rgba(0,0,0,0.5)",
                }}
              >
                <div style={{ fontSize: 12, textTransform: "uppercase", opacity: 0.7 }}>
                  On-Chain ZK Flow
                </div>
                <h2 style={{ margin: "4px 0 8px", fontSize: 18 }}>GoDark Risk</h2>
                <div
                  style={{
                    fontSize: 40,
                    fontWeight: 600,
                    color: godarkAccent,
                    lineHeight: 1.1,
                  }}
                >
                  {Math.round((godark.confidence || 0) * 100)}%
                </div>
                <div
                  style={{
                    background: godarkAccent,
                    color: "#fff",
                    padding: "6px 14px",
                    borderRadius: 999,
                    display: "inline-block",
                    marginTop: 8,
                    fontSize: 12,
                    letterSpacing: 1,
                  }}
                >
                  {(godark.risk_level || "").toUpperCase() || "NORMAL"}
                </div>
                <p style={{ marginTop: 12, fontSize: 13, opacity: 0.85 }}>
                  {godark.summary}
                </p>
                <p style={{ marginTop: 4, fontSize: 12, opacity: 0.7 }}>
                  Universe: Ethereum mainnet zk verifier calls and partner custody wallets.
                </p>
              </div>

              {/* Macro Tile */}
              <div
                style={{
                  background: "#020617",
                  padding: 20,
                  borderRadius: 12,
                  minWidth: 260,
                  maxWidth: 360,
                  textAlign: "left",
                  border: "1px solid #1f2937",
                  boxShadow: "0 10px 30px rgba(0,0,0,0.5)",
                }}
              >
                <div style={{ fontSize: 12, textTransform: "uppercase", opacity: 0.7 }}>
                  Futures Macro Flow
                </div>
                <h2 style={{ margin: "4px 0 8px", fontSize: 18 }}>Macro Regime</h2>
                <div
                  style={{
                    fontSize: 40,
                    fontWeight: 600,
                    color: macroAccent,
                    lineHeight: 1.1,
                  }}
                >
                  {(macro.urgency || 0).toFixed(0)}
                </div>
                <div
                  style={{
                    background: macroAccent,
                    color: "#fff",
                    padding: "6px 14px",
                    borderRadius: 999,
                    display: "inline-block",
                    marginTop: 8,
                    fontSize: 12,
                    letterSpacing: 1,
                  }}
                >
                  {(macro.regime || "idle").toUpperCase()}
                </div>
                <p style={{ marginTop: 12, fontSize: 13, opacity: 0.85 }}>
                  {macro.label}
                </p>
                <p style={{ marginTop: 4, fontSize: 12, opacity: 0.7 }}>
                  Universe: ES (CME E-mini S&P 500) and NQ (CME E-mini Nasdaq-100) via Databento.
                </p>
              </div>
            </div>

            <div style={{ textAlign: "center", fontSize: 12, opacity: 0.7 }}>
              Updated at {flow.updated_at}
            </div>

            <div
              style={{
                maxWidth: 820,
                margin: "24px auto 0",
                fontSize: 12,
                opacity: 0.85,
              }}
            >
              <div style={{ fontSize: 13, fontWeight: 500, marginBottom: 6 }}>
                Tracked instruments
              </div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 16 }}>
                <div style={{ minWidth: 220 }}>
                  <div style={{ fontWeight: 500 }}>On-chain (GoDark)</div>
                  <ul style={{ margin: "4px 0 0", paddingLeft: 18 }}>
                    <li>Ethereum mainnet zk verifier calls</li>
                    <li>Partner & custody wallet flows</li>
                  </ul>
                </div>
                <div style={{ minWidth: 220 }}>
                  <div style={{ fontWeight: 500 }}>Macro (Futures)</div>
                  <ul style={{ margin: "4px 0 0", paddingLeft: 18 }}>
                    <li>ES – CME E-mini S&amp;P 500</li>
                    <li>NQ – CME E-mini Nasdaq-100</li>
                  </ul>
                </div>
              </div>
            </div>

            <div
              style={{
                maxWidth: 820,
                margin: "24px auto 0",
                fontSize: 12,
                opacity: 0.9,
              }}
            >
              <div style={{ fontSize: 13, fontWeight: 500, marginBottom: 6 }}>
                Market snapshot
              </div>
              <div
                style={{
                  display: "flex",
                  flexWrap: "wrap",
                  gap: 16,
                }}
              >
                <div
                  style={{
                    flex: "1 1 160px",
                    minWidth: 160,
                    padding: 12,
                    borderRadius: 10,
                    border: "1px solid #1f2937",
                    background: "#020617",
                  }}
                >
                  <div style={{ fontSize: 11, opacity: 0.7 }}>Crypto</div>
                  <div style={{ fontSize: 14, fontWeight: 500 }}>XRP</div>
                  <div style={{ fontSize: 20, fontWeight: 600, marginTop: 4 }}>
                    {fmtPrice(xrp)}
                  </div>
                </div>
                <div
                  style={{
                    flex: "1 1 160px",
                    minWidth: 160,
                    padding: 12,
                    borderRadius: 10,
                    border: "1px solid #1f2937",
                    background: "#020617",
                  }}
                >
                  <div style={{ fontSize: 11, opacity: 0.7 }}>Crypto</div>
                  <div style={{ fontSize: 14, fontWeight: 500 }}>ETH</div>
                  <div style={{ fontSize: 20, fontWeight: 600, marginTop: 4 }}>
                    {fmtPrice(eth)}
                  </div>
                </div>
                <div
                  style={{
                    flex: "1 1 160px",
                    minWidth: 160,
                    padding: 12,
                    borderRadius: 10,
                    border: "1px solid #1f2937",
                    background: "#020617",
                  }}
                >
                  <div style={{ fontSize: 11, opacity: 0.7 }}>Index</div>
                  <div style={{ fontSize: 14, fontWeight: 500 }}>S&amp;P 500 (SPY)</div>
                  <div style={{ fontSize: 20, fontWeight: 600, marginTop: 4 }}>
                    {fmtPrice(spy)}
                  </div>
                </div>
                <div
                  style={{
                    flex: "1 1 160px",
                    minWidth: 160,
                    padding: 12,
                    borderRadius: 10,
                    border: "1px solid #1f2937",
                    background: "#020617",
                  }}
                >
                  <div style={{ fontSize: 11, opacity: 0.7 }}>Index</div>
                  <div style={{ fontSize: 14, fontWeight: 500 }}>Nasdaq 100 (QQQ)</div>
                  <div style={{ fontSize: 20, fontWeight: 600, marginTop: 4 }}>
                    {fmtPrice(qqq)}
                  </div>
                </div>
              </div>
            </div>

            <SDUIFeed />
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<FlowDashboard />);
    </script>
  </body>
</html>
